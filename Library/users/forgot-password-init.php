<?phprequire_once(LIB_PATH . 'GlobalManager.php');$globalManager = GlobalManager::getInstance();require_once(LIB_PATH. "PHPMailer/class.phpmailer.php");if(isset($_SESSION['message']) && trim($_SESSION['message']) !== ""){    $showForm = false;}else{    $showForm = true;}$errors = array();if(isset($_POST['forgot-password']) && trim($_POST['forgot-password'])=='Submit') {	if(isset($_POST['email']) && trim($_POST['email'])=='') {		$errors[] = "E-mail cannot be left blank";	}else{        //first check out for existing email        $condition = "email='".$_POST['email']."'";        $result = $globalManager->runSelectQuery("users", "id,firstname,lastname,email", $condition);        if(is_array($result) && count($result) > 0){			$updateArray = array();			$uniqueCode = UtilityManager::generateUniqueSecurityCode(28).$result[0]['id'];			$updateArray['pwd_reset_code'] = $uniqueCode;			$where = "id='".$result[0]['id']."'";			$adv_password = $globalManager->runUpdateQuery("users",$updateArray,$where);            if($adv_password){                //send email to owner                $contact_to_email = $result[0]['email'];                $visitor_name = ucwords($result[0]['firstname']);				$resetUrl = SITE_URL.'reset-password.php?cid='.$uniqueCode;								$message="Hi ".ucwords($visitor_name).",";                $message .= "<p>Can't remember your password? Don't worry about it.</p><p>Please click on below link to reset your password.</p>";                $message .= '<p><a href="'.$resetUrl.'">'.$resetUrl.'</a></p><br />';                                $template = file_get_contents(LIB_HTML.'user_email_template.php');                //replace content                $message = str_replace('{CONTENT_FOR_LAYOUT}', $message, $template);                $phpmailer = new phpmailer();                $phpmailer->SetLanguage("en", LIB_PATH. "PHPMailer/language/");                $phpmailer->CharSet = "UTF-8";                $phpmailer->Priority = 1;                $phpmailer->AddCustomHeader("X-MSMail-Priority: High");                $phpmailer->AddCustomHeader("Importance: High");                $phpmailer->IsSMTP();                $phpmailer->SMTPAuth = true;                $phpmailer->SMTPSecure = 'ssl';                $phpmailer->Host = "smtp.gmail.com";                $phpmailer->SMTPDebug  = 0;                $phpmailer->Mailer = "smtp";                $phpmailer->Port = 465;                            $phpmailer->Username = SUPPORT_EMAIL;                $phpmailer->Password = SUPPORT_EMAIL_PASSWORD;                $phpmailer->From = SUPPORT_EMAIL;                $phpmailer->FromName = SUPPORT_EMAIL_USERNAME;                                $phpmailer->IsHTML(TRUE);                $phpmailer->AddAddress($contact_to_email, $visitor_name);                $phpmailer->Body = $message;                $phpmailer->MsgHTML = $message;                $phpmailer->Subject = "Reset Password | ".SITE_NAME;                $sendmail = $phpmailer->send();                if($sendmail) {                    $_SESSION['message'] = "A new password link has been sent to your email address.";                    redirect(USER_SITE_URL.'forgot-password.php');                }else{                    $_SESSION['errmsg'] = "Mailer Error: " . $phpmailer->ErrorInfo;//"Email could not send.";                    redirect(USER_SITE_URL.'forgot-password.php');                }            }        }		else{			$_SESSION['errmsg'] = "We have no record of this email address. Please try a different email or create a new account.";		}    }}?>